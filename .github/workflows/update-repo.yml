name: Update APT Repository

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'
  repository_dispatch:
    types: [new-release]

env:
  SOURCE_REPO: xxanqw/mikusays
  GPG_KEY_ID: 1400C594BC446805BD928F020B493CCBC94A2D44

jobs:
  update-repo:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: Checkout APT repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev apt-utils gnupg2 curl jq

      - name: Import GPG key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          export GNUPGHOME="${HOME}/.gnupg"
          mkdir -p "$GNUPGHOME"
          chmod 700 "$GNUPGHOME"
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          echo "allow-loopback-pinentry" >> "$GNUPGHOME/gpg-agent.conf"
          echo "pinentry-mode loopback" >> "$GNUPGHOME/gpg.conf"
          gpgconf --kill gpg-agent || true
          gpgconf --launch gpg-agent || true

      - name: Create repository structure
        run: |
          mkdir -p repo/pool/main
          mkdir -p repo/dists/stable/main/binary-amd64
          mkdir -p repo/dists/stable/main/binary-arm64

      - name: Download DEB packages from latest release
        run: |
          echo "Fetching latest release from $SOURCE_REPO..."
          RELEASE_DATA=$(curl -s "https://api.github.com/repos/$SOURCE_REPO/releases/latest")
          DEBS=$(echo "$RELEASE_DATA" | jq -r '.assets[] | select(.name | endswith(".deb")) | .browser_download_url')

          if [ -z "$DEBS" ]; then
            echo "No DEB packages found in latest release"
            exit 1
          fi

          cd repo/pool/main
          for url in $DEBS; do
            echo "Downloading: $url"
            curl -L -O "$url"
          done

      - name: Generate Packages files
        run: |
          cd repo
          dpkg-scanpackages --arch amd64 pool/ > dists/stable/main/binary-amd64/Packages
          gzip -kf dists/stable/main/binary-amd64/Packages
          dpkg-scanpackages --arch arm64 pool/ > dists/stable/main/binary-arm64/Packages
          gzip -kf dists/stable/main/binary-arm64/Packages

      - name: Generate Release file
        run: |
          cd repo/dists/stable
          
          # Generate configuration for apt-ftparchive
          cat <<EOF > apt-ftparchive.conf
          APT::FTPArchive::Release::Origin "xxanqw";
          APT::FTPArchive::Release::Label "xxanqw's APT Repository";
          APT::FTPArchive::Release::Suite "stable";
          APT::FTPArchive::Release::Codename "stable";
          APT::FTPArchive::Release::Architectures "amd64 arm64";
          APT::FTPArchive::Release::Components "main";
          APT::FTPArchive::Release::Description "xxanqw's personal APT repository";
          EOF

          apt-ftparchive -c apt-ftparchive.conf release . > Release

      - name: Sign Release file
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          GPG_KEY_ID: ${{ env.GPG_KEY_ID }}
        run: |
          cd repo/dists/stable
          gpg --batch --yes --default-key "$GPG_KEY_ID" --pinentry-mode loopback --passphrase "$GPG_PASSPHRASE" --armor --detach-sign --output Release.gpg Release
          gpg --batch --yes --default-key "$GPG_KEY_ID" --pinentry-mode loopback --passphrase "$GPG_PASSPHRASE" --clearsign --output InRelease Release

      - name: Copy public key
        run: |
          cp public.asc repo/public.asc

      - name: Create installation instructions
        run: |
          cat > repo/index.html <<'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>xxanqw's APT Repository</title>
            <style>
              body { font-family: system-ui, sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; line-height: 1.5; }
              pre { background: #f4f4f4; padding: 1rem; border-radius: 4px; overflow-x: auto; }
              code { font-family: monospace; }
            </style>
          </head>
          <body>
          <h1>xxanqw's APT Repository</h1>
          <p>To install packages from this repository, run the following commands:</p>
          <pre>
          # 1. Add the GPG Key
          wget -O - https://xxanqw.github.io/apt-repository/public.asc | sudo gpg --dearmor -o /usr/share/keyrings/xxanqw-archive-keyring.gpg

          # 2. Add the Repository
          echo "deb [arch=amd64,arm64 signed-by=/usr/share/keyrings/xxanqw-archive-keyring.gpg] https://xxanqw.github.io/apt-repository/repo stable main" | sudo tee /etc/apt/sources.list.d/xxanqw.list

          # 3. Update and Install
          sudo apt update
          sudo apt install mikusays
          </pre>
          </body></html>
          EOF

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'repo'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
