name: Update Repositories (APT & RPM)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'
  repository_dispatch:
    types: [new-release]

env:
  SOURCE_REPO: xxanqw/mikusays
  GPG_KEY_ID: 1400C594BC446805BD928F020B493CCBC94A2D44

jobs:
  update-repo:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev apt-utils gnupg2 gpg-agent curl jq rpm createrepo-c

      - name: Import GPG key & Preset Passphrase
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          export GNUPGHOME="${HOME}/.gnupg"
          echo "GNUPGHOME=$GNUPGHOME" >> $GITHUB_ENV
          mkdir -p "$GNUPGHOME"
          chmod 700 "$GNUPGHOME"

          # Import Key
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import

          # Configure Agent
          echo "allow-preset-passphrase" >> "$GNUPGHOME/gpg-agent.conf"
          
          # Restart agent
          gpgconf --kill gpg-agent || true
          gpgconf --launch gpg-agent || true

          # Extract Keygrip and Preset
          KEYGRIP=$(gpg --list-secret-keys --with-colons | grep '^grp:' | awk -F: '{print $10}' | head -n 1)
          PRESET_CMD=$(find /usr -name gpg-preset-passphrase -type f -executable -print -quit)
          
          if [ -z "$PRESET_CMD" ]; then
            echo "Error: gpg-preset-passphrase not found"
            exit 1
          fi
          
          "$PRESET_CMD" --preset --passphrase "$GPG_PASSPHRASE" "$KEYGRIP"

          # Configure RPM macros
          echo "%_signature gpg" > ~/.rpmmacros
          echo "%_gpg_name $GPG_KEY_ID" >> ~/.rpmmacros
          echo "%_gpg_path $GNUPGHOME" >> ~/.rpmmacros

      # ==========================================
      # SECTION: APT (DEBIAN/UBUNTU)
      # ==========================================
      - name: APT - Create structure
        run: |
          mkdir -p repo/pool/main
          mkdir -p repo/dists/stable/main/binary-amd64
          mkdir -p repo/dists/stable/main/binary-arm64

      - name: APT - Download DEBs
        run: |
          RELEASE_DATA=$(curl -s "https://api.github.com/repos/$SOURCE_REPO/releases/latest")
          DEBS=$(echo "$RELEASE_DATA" | jq -r '.assets[] | select(.name | endswith(".deb")) | .browser_download_url')
          
          if [ -n "$DEBS" ]; then
            cd repo/pool/main
            for url in $DEBS; do curl -L -O "$url"; done
            cd ../../..
          else
            echo "No DEB files found, skipping APT download."
          fi

      - name: APT - Generate Metadata
        run: |
          cd repo
          dpkg-scanpackages -m pool/ > dists/stable/main/binary-amd64/Packages
          gzip -kf dists/stable/main/binary-amd64/Packages
          dpkg-scanpackages -m pool/ > dists/stable/main/binary-arm64/Packages
          gzip -kf dists/stable/main/binary-arm64/Packages

      - name: APT - Generate Release & Sign
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          cd repo/dists/stable
          cat <<EOF > apt-ftparchive.conf
          APT::FTPArchive::Release::Origin "xxanqw";
          APT::FTPArchive::Release::Label "xxanqw APT";
          APT::FTPArchive::Release::Suite "stable";
          APT::FTPArchive::Release::Codename "stable";
          APT::FTPArchive::Release::Architectures "amd64 arm64";
          APT::FTPArchive::Release::Components "main";
          EOF
          apt-ftparchive -c apt-ftparchive.conf release . > Release
          
          gpg --batch --yes --default-key "$GPG_KEY_ID" --pinentry-mode loopback --passphrase "$GPG_PASSPHRASE" --armor --detach-sign --output Release.gpg Release
          gpg --batch --yes --default-key "$GPG_KEY_ID" --pinentry-mode loopback --passphrase "$GPG_PASSPHRASE" --clearsign --output InRelease Release

      # ==========================================
      # SECTION: RPM (FEDORA/RHEL)
      # ==========================================
      - name: RPM - Create structure & Download
        run: |
          mkdir -p rpm_repo
          
          RELEASE_DATA=$(curl -s "https://api.github.com/repos/$SOURCE_REPO/releases/latest")
          RPMS=$(echo "$RELEASE_DATA" | jq -r '.assets[] | select(.name | endswith(".rpm")) | .browser_download_url')

          if [ -n "$RPMS" ]; then
            cd rpm_repo
            for url in $RPMS; do 
              echo "Downloading $url"
              curl -L -O "$url"
            done
          else
            echo "No RPM files found."
          fi

      - name: RPM - Sign Packages
        run: |
          cd rpm_repo
          if ls *.rpm 1> /dev/null 2>&1; then
            rpmsign --addsign *.rpm
          fi

      - name: RPM - Generate Metadata
        run: |
          createrepo_c rpm_repo/

      - name: RPM - Generate .repo file
        run: |
          cat <<EOF > rpm_repo/xxanqw.repo
          [xxanqw]
          name=xxanqw's Repository
          baseurl=https://apt.xxanqw.pp.ua/rpm/
          enabled=1
          gpgcheck=1
          gpgkey=https://apt.xxanqw.pp.ua/public.asc
          repo_gpgcheck=0
          EOF

      # ==========================================
      # SECTION: DEPLOYMENT
      # ==========================================
      - name: Copy public key
        run: cp public.asc repo/public.asc

      - name: Create Landing Page
        # UPDATED: Uses universal 'curl' command instead of specific dnf flags
        run: |
          cat > repo/index.html <<'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <title>xxanqw's Repository</title>
            <style>
              body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; line-height: 1.5; }
              pre { background: #f4f4f4; padding: 1rem; border-radius: 4px; overflow-x: auto; }
            </style>
          </head>
          <body>
          <h1>xxanqw's Repository</h1>
          
          <h3>Debian / Ubuntu</h3>
          <pre>
          wget -O - https://apt.xxanqw.pp.ua/public.asc | sudo gpg --dearmor -o /usr/share/keyrings/xxanqw.gpg
          echo "deb [signed-by=/usr/share/keyrings/xxanqw.gpg] https://apt.xxanqw.pp.ua/repo stable main" | sudo tee /etc/apt/sources.list.d/xxanqw.list
          sudo apt update && sudo apt install mikusays
          </pre>

          <h3>Fedora / RHEL / CentOS</h3>
          <pre>
          sudo curl -o /etc/yum.repos.d/xxanqw.repo https://apt.xxanqw.pp.ua/rpm/xxanqw.repo
          sudo dnf install mikusays
          </pre>
          </body></html>
          EOF

      - name: Prepare Site Structure
        run: |
          mkdir _site
          mv repo _site/repo
          mv rpm_repo _site/rpm
          cp _site/repo/index.html _site/index.html
          cp _site/repo/public.asc _site/public.asc

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
